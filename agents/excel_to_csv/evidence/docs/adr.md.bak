# ADR
- title: 采用渐进式重构与模块化架构优化 excel_to_csv
- status: proposed
- date: 2026-01-05

## context
- 背景: 现有 excel_to_csv 模块需要提升性能、改善UI体验并实现模块化架构，同时必须保持功能一致性和CLI兼容性。现有代码存在长函数、耦合度高、缺乏可视化界面等问题。
- 约束:
    1.  功能一致性必须保证。
    2.  性能指标严格（skip_llm=false < 90s, skip_llm=true < 30s）。
    3.  必须基于现有项目路径修改，不能新建项目结构。
    4.  必须保持现有CLI参数接口。
    5.  需要交付完整的审查产物和文档。

## decision
- 选择: 采用渐进式重构策略，将现有单体 `agent.py` 拆分为清晰的三层架构（UI层、核心逻辑层、配置管理层），并在此过程中嵌入性能优化（并发处理、Pandas操作优化）和新的Streamlit UI。核心逻辑层将逐步替换现有 `agent.py` 中的函数，最终保持原CLI入口作为适配器。

## alternatives
- 备选:
    1.  激进式重写（方案B）：采用全新异步架构和插件化设计。优点是架构更现代、扩展性极强。缺点是风险高、开发周期长、与现有功能一致性验证困难。
    2.  最小化修改（方案C）：仅优化热点代码并包装UI。优点是改动最小、风险最低。缺点是架构未改善，技术债务依旧，长期维护成本高，性能提升可能有限。
- 取舍: 方案A（渐进式重构）在风险、开发成本、架构改善和性能提升之间取得了最佳平衡。它允许我们分阶段交付价值，每一步都可以验证功能一致性，符合项目“基于现有代码修改”的硬性要求。

## consequences
- 短期影响:
    -   开发初期需要投入时间进行代码分析和模块划分。
    -   需要编写额外的集成测试来保证功能一致性。
    -   团队需要熟悉新的模块化结构和Streamlit开发。
- 长期维护成本:
    -   降低。清晰的模块边界和分离的关注点使得代码更易理解、测试和修改。
    -   性能优化和并发控制内置在架构中，便于后续调整。
    -   UI与核心逻辑解耦，两者可以独立演进。
    -   配置管理标准化，便于部署和用户自定义。