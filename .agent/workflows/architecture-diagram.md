---
description: 使用 Draw.io 和 MCP 生成清晰、可读、专业级的代理架构图。优先确保布局规范、避免常见问题（如线条乱连、重叠遮盖），美学作为加分项，提升视觉吸引力
---

# 架构图工作流（Architecture Diagram Workflow）
## 引言
此工作流在代理项目（agents project）的架构规划阶段自动触发。它利用 Draw.io 进行可视化绘图，通过 MCP（drawio-mcp-server）工具链实现 AI 辅助生成与程序化迭代。
**核心目标**：产出**清晰、可读、专业的架构图**，确保团队高效理解系统结构。首先解决 AI 生成常见问题（线条交叉乱连、节点重叠遮盖、布局杂乱），信息传达准确无歧义。美学设计仅作为加分项，在清晰前提下提升专业感与可读性。
关键触发条件：
- 新架构提案
- 影响系统结构的代码变更
- 定期架构审查
## 首要原则：清晰布局规范（必须严格遵守）
AI 生成图表最常见失败点是布局混乱。所有生成与编辑操作必须遵循以下规范：
- **避免连接线乱连与交叉**  
  优先使用层次布局（Hierarchical 或 Tree）。边路由必须指定明确端口（exitX/Y、entryX/Y），必要时添加 waypoints 绕开障碍。双向连接使用相对侧端口，避免路径重合。
- **防止节点重叠与遮盖**  
  启用网格对齐（grid=1），节点间最小水平间距 180px，垂直间距 120px。所有节点坐标严格控制在 x=40–760、y=40–560 范围内。大型图必须使用容器（group）或图层（Layers）分组。
- **整体布局方向**  
  统一采用**从左到右**流动，确保单一入口（起点）和出口（终点）。复杂流程分层为子图，避免单页拥挤。
- **符号一致性（参考 BPMN 标准）**  
  - 矩形（rounded=1）：活动、组件、服务  
  - 菱形（rhombus）：决策点（文本严格少于 5 个中文词）  
  - 平行四边形：数据输入/输出  
  - 圆角矩形或椭圆：起始/终止  
  - 箭头：流向（必要时带条件标签）
- **必备信息要求**  
  明确标注输入/输出、条件分支、异常处理路径。使用颜色区分阶段（绿色输入、蓝色处理、橙色决策、红色异常），总颜色数不超过 5 种。
## 美学加分项（清晰优先，美学次之）
在完全满足布局规范后，可适度应用以下技巧提升专业感：
- **颜色与线条**  
  避免纯黑（#000000），使用柔和深灰 #333333 作为描边色。节点填充色透明度 90–100%。连接线优先 curved=1，轻微阴影（shadow=1）可选。
- **中文字体推荐（提升可读性）**  
  | 用途       | 推荐字体               | 备选字体             | 特点             |
  |------------|-------------------------|----------------------|------------------|
  | 大标题     | 阿里巴巴普惠体 Bold    | 思源黑体 Bold       | 醒目、专业       |
  | 小标题/节点| 思源黑体 Medium        | 腾讯兰亭黑 Pro      | 清晰稳重         |
  | 正文/标签  | 思源宋体 Regular       | Noto Serif CJK      | 高可读性         |
  **Draw.io 导入方法**：Edit Style → 添加 `fontFamily="思源黑体"` 或 `fontFamily="阿里巴巴普惠体"`。
- **背景与空间**  
  推荐纯白背景或极浅灰 (#F8F9FA)，适度留白。全局主题选择 Minimal，避免过多装饰。
## MCP 工具链使用规范（推荐工作流）
为彻底解决布局问题，必须使用以下 MCP 工具顺序：
1. **start_session**  
   启动嵌入服务器并打开浏览器，实现实时预览与手动干预。
2. **create_new_diagram**  
   使用完整 mxGraphModel XML 创建新图。必须遵守：
   - 所有节点 parent="1"，ID 从 "2" 开始唯一
   - 坐标范围 x=40–760, y=40–560
   - 节点间距 180px（水平）、120px（垂直）
   - 边路由显式指定 exitX/Y、entryX/Y 和 waypoints
   - 样式包含中文字体、圆角、阴影
3. **get_diagram**（关键！）  
   在任何编辑前必须调用，获取最新 XML（包含用户浏览器手动调整），防止变更丢失。
4. **edit_diagram**  
   基于 get_diagram 返回的 XML 进行增删改：
   - 添加/更新节点时指定精确几何位置
   - 修复乱连时更新边的 waypoints 或端口
   - 删除冗余或重叠元素
5. **export_diagram**  
   导出最终 .drawio 文件（含嵌入 SVG），用于文档嵌入。
**MCP XML 生成提示模板**（AI 必须使用）：
> 生成代理架构图的完整 mxGraphModel XML。严格左到右层次布局，所有节点间水平间距至少180px，无任何线条交叉或节点重叠。使用矩形(rounded=1)表示组件、菱形表示决策、平行四边形表示输入输出。边使用 curved=1 并显式指定 exitX=1 exitY=0.5 entryX=0 entryY=0.5，必要时添加 waypoints 绕开。字体：标题阿里巴巴普惠体 Bold，正文思源宋体。颜色：绿色输入(#d5e8d4)、蓝色处理(#dae8fc)、红色异常(#f8cecc)。添加轻微阴影 shadow=1。
## 工作流步骤（完整版）
1. **触发**：架构规划启动（Git hook / CI / 手动）。
2. **启动会话**：调用 `start_session`，打开浏览器实时预览。
3. **初始生成**：使用 `create_new_diagram` + 规范 XML 创建基础图。
4. **迭代审查**：
   - 调用 `get_diagram` 获取当前状态
   - 检查：无交叉、无重叠、信息完整
   - 如有问题，使用 `edit_diagram` 精确修复（调整坐标、waypoints）
   - 必要时在浏览器手动拖拽调整 → 再次 get_diagram 捕获
5. **美学优化**（可选）：适度添加圆角、阴影、中文字体。
6. **导出与文档化**：调用 `export_diagram`，更新本 MD 文件并嵌入最新 SVG。
7. **交付**：分享给团队审阅，提交仓库。
### 示例图表
（实际运行后替换为最新导出）
<img src="diagrams/agent-architecture-latest.drawio.svg" alt="最新代理架构图（清晰规范布局）" width="100%">
## 参考资料
- Draw.io 官网：https://www.diagrams.net/
- MCP 工具文档：drawio-mcp-server GitHub
- 中文字体：思源字体系列（Google Fonts/Noto）、阿里巴巴普惠体
此文档为**活文档**——每次架构变更必须同步更新图表与规范，确保始终以清晰为第一优先级！