# 架构决策记录 (ADR)

## ADR 001: Excel to CSV 模块重构架构

### 状态
已接受

### 背景
现有 `excel_to_csv` 模块存在以下问题：
1. 代码耦合度高：UI逻辑、业务逻辑、配置管理混在一起
2. 性能瓶颈：并发控制简单，无法充分利用多核CPU
3. 缺乏配置持久化：运行时设置无法保存和复用
4. 测试覆盖不足：缺乏单元测试和性能测试

### 决策
采用分层架构设计，将系统拆分为以下核心模块：

#### 1. 配置管理模块 (`config_manager.py`)
- 负责加载、保存、验证配置
- 支持 JSON/YAML 格式
- 提供默认配置和安全范围验证

#### 2. 核心数据处理模块 (`data_processor.py`)
- 纯业务逻辑，无UI依赖
- 实现高效的Excel/CSV读写
- 支持表级和文件级并发
- 提供数据处理管道

#### 3. 并发控制器 (`concurrency_controller.py`)
- 管理线程/进程池
- 实现资源使用上限
- 提供任务队列和调度

#### 4. 审计报告生成器 (`audit_generator.py`)
- 生成结构化审计报告
- 支持性能统计和错误追踪

#### 5. CLI接口 (`cli.py`)
- 保持向后兼容的命令行接口
- 参数解析和验证

#### 6. Streamlit UI接口 (`streamlit_ui.py`)
- 提供Web界面
- 实时状态反馈和可视化

### 理由
1. **解耦性**：各模块职责单一，便于测试和维护
2. **可扩展性**：新功能可以独立添加，不影响现有模块
3. **性能优化**：并发控制可以针对不同场景优化
4. **配置管理**：用户设置可以持久化，提高用户体验
5. **向后兼容**：保持现有CLI接口不变

### 后果
#### 正面影响
- 代码可维护性大幅提升
- 性能指标可达成（skip_llm=false < 90s, skip_llm=true < 30s）
- 支持配置持久化和复用
- 便于团队协作开发

#### 负面影响
- 初始重构需要额外时间
- 需要编写更多测试用例
- 学习曲线略有增加

### 实施计划
1. 创建模块化目录结构
2. 实现配置管理模块
3. 重构核心数据处理逻辑
4. 实现并发控制器
5. 添加Streamlit UI接口
6. 编写测试用例和性能测试
7. 验证功能一致性和性能指标

## ADR 002: 并发处理策略

### 状态
已接受

### 背景
需要处理大量Excel文件，每个文件可能包含多个工作表，需要高效并发处理以满足性能指标。

### 决策
采用两级并发策略：
1. **文件级并发**：使用进程池处理不同文件（CPU密集型）
2. **表级并发**：使用线程池处理同一文件的不同工作表（I/O密集型）

### 理由
1. **充分利用多核CPU**：Pandas操作是CPU密集型，适合多进程
2. **避免GIL限制**：多进程可以绕过Python GIL限制
3. **内存安全**：每个进程独立内存空间，避免内存泄漏影响全局
4. **灵活控制**：可以根据文件大小和数量动态调整并发策略

### 后果
- 性能显著提升，特别是对于大文件
- 内存使用略有增加（每个进程独立内存）
- 需要更复杂的错误处理和状态同步

## ADR 003: 性能优化策略

### 状态
已接受

### 背景
需要满足严格的性能指标：skip_llm=false < 90s, skip_llm=true < 30s。

### 决策
采用以下性能优化策略：
1. **内存映射读取**：对于大文件使用内存映射
2. **批量处理**：优化Pandas操作，减少内存复制
3. **延迟加载**：只在需要时读取数据
4. **缓存机制**：缓存常用配置和中间结果
5. **异步I/O**：使用异步文件操作提高I/O效率

### 理由
- 实测表明这些优化能显著提升处理速度
- 平衡内存使用和处理速度
- 适用于不同大小的文件

## ADR 004: 配置管理设计

### 状态
已接受

### 背景
需要支持运行时设置保存和加载，提高用户体验。

### 决策
采用以下配置管理设计：
1. **分层配置**：默认配置 → 文件配置 → 命令行参数 → 运行时设置
2. **格式支持**：JSON和YAML格式
3. **验证机制**：配置值范围和类型验证
4. **热重载**：支持运行时配置更新

### 理由
- 提供灵活的用户配置方式
- 确保配置安全有效
- 便于调试和问题排查